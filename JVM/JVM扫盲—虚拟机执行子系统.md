# JVM扫盲—虚拟机执行子系统

## 1、类文件结构

Java虚拟机只与Class文件相关联，它规定了Class文件应该具有的格式，而不论该文件是由什么语言编写并编译而来。所以，任何语言只要能够最终编译成符合Java虚拟机要求的Class文件，就可以运行在Java虚拟机上面。就是说，不论是使用Java, Scala, Kotlin, Groovy还是其他语言，只要编译出的Class文件符合虚拟机规范，那么都可以被虚拟机执行。所以，实际上Java规范就是由Java语言规范和Java虚拟机规范两个独立的部分组成。

Class类文件是一种二进制文件，它包含了Java虚拟机指令集和符号表以及若干其他辅助信息。Class文件格式采用类似于C的伪结构来存储数据，这种结构只有两种数据类型：无符号数和表。无符号数属于基本数据类型，以`u1`,`u2`,`u4`,`u8`分别代表1字节、2字节、4字节和8字节的无符号数，无符号数可以用来描述数字、索引、数量值或者按照utf-8编码构成的字符串。

表是由多个无符号数或者其他作为表作为数据项构成的复合数据结构，所有表习惯性地以"_info"结尾，整个Class文件本质上是一张表。而所谓的表就对应于C++中的一个结构体，比如整个Class文件对应的结构体就是：

    struct ClassFile {
        u4 magic;                // 识别Class文件格式，具体值为0xCAFEBABE，
        u2 minor_version;        // Class文件格式副版本号，
        u2 major_version;        // Class文件格式主版本号，
        u2 constant_pool_count;  // 常量表项个数，
        cp_info **constant_pool; // 常量表，又称变长符号表，
        u2 access_flags;         // Class的声明中使用的修饰符掩码，
        u2 this_class;           // 常数表索引，索引内保存类名或接口名，
        u2 super_class;          // 常数表索引，索引内保存父类名，
        u2 interfaces_count;     // 超接口个数，
        u2 *interfaces;          // 常数表索引，各超接口名称，
        u2 fields_count;         // 类的域个数，
        field_info **fields;     // 域数据，包括属性名称索引，
        u2 methods_count;        // 方法个数，
        method_info **methods;   // 方法数据，包括方法名称索引，方法修饰符掩码等，
        u2 attributes_count;         // 类附加属性个数，
        attribute_info **attributes; // 类附加属性数据，包括源文件名等。
    };

上面结构体的各个变量的定义的顺序与Class文件中的存储顺序是一致的。下面我们用一个二进制编辑器打开Class文件并简单看下，Class文件中的存储如何与上面的结构体对应的。

![Class二进制文件](https://camo.githubusercontent.com/93f6368098544e8fcdb1c8c5e23448d8ddca33d0/687474703a2f2f75706c6f61642e6f756c69752e6e65742f692f3230313731313031313234383538736a7879332e706e67)

根据结构体的定义，首先是magic字段，它是u4类型的，即4字节，对应于上图中的`CAFEBABE`；紧接着两个u2类型的字段，minor_version和major_version，用来表示Class文件的版本号，对应于上图中的`00000031`；然后是一个u2类型的constant_pool_count，用来表示常数表项个数，这里是`0027`，也就是有38个常量，因此常量从1开始计数的；接着常量个数的是变长符号表，这个符号表的长度就是之前常量的长度，即38，然后我们要按照常量的规则找到38个常量之后就是u2类型的访问标志。

那这38个常量又如何寻找呢？实际上，Class文件中总计规定了14种常量结构体，每种结构体都包含一个`tag`字段，它是u1类型的，即1个字节，并且存储在该结构体的首位。我们需要先根据该`tag`字段找到该常量的定义，然后才能确定接下来的几个字节是属于该常量的。比如上图中的第一个常量的`tag`是`0A`，我们可以查询相关的表知道它是`CONSTANT_Fleddef_info`类型的常量，该常量有3个字段：u1类型的tag, u2类型的index, u2类型的index，故我们可以确定常量长度之后的5个字节是属于第一个常量的。依次，分析下去我们可以得到第二个，第三个等常量的信息。得到了常量的信息之后，就可以获取上面结构体中其他的字段的信息。

其实，按照上面的分析，我们可以看出分析Class文件时一个非常机械的过程，因为它有固定的规则在里面，所以我们可以使用命令行工具`javap`来获取以上的信息。在实际开发过程中从字节码的角度分析问题的情形可能并不多，但是了解字节码中的一些指令，尤其是并发相关的指令，对学习和分析问题都大有裨益。









