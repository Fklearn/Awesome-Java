## 运输层

运输层协议为运行在不同主机上的应用进程提供了**逻辑通信**功能。**运输层**协议只工作在端系统，它将来自应用程序的报文移动到**网络层**，而不论这些报文在网络层如何传输。所以，传输层能够提供的服务受限于网络层。但它也能提供网络层无法提供的服务。假如Ann每天收集家里人的信件并交给邮差，那么这个收集过程属于运输层，而递交给邮差之后的运输过程可以看作网络层。

### 1.多路复用和多路分解

应用层和运输层之间的交互是通过**套接字**来完成的，就是说运输层并没有直接把数据交付给进行，而是交给了一个中间套接字。将运输层报文段中的数据交给到正确的套接字的工作称为**多路分解**。在源主机从不同套接字中收集数据块，并为每个数据块封装首部信息，然后将报文段传送到网络的过程叫做**多路复用**。具体是通过为每个套接字指定一个端口号，在运输层通过检查端口号，来讲报文段定向到对应的套接字。

端口号是16比特的数，大小在0~65535之间，其中0~1023是周知端口号，不能由用户来分配。

### 2.面向无连接的运输：UDP

##### 特点：

1. **面向无连接的协议**：UDP不需要三次握手建立连接，不需要任何准备即可开始数据传输，因此不会引入连接延时。TCP不需要维护连接状态，也不跟踪收发缓存、拥塞控制及确认号等参数。
2. **UDP分组首部只有8字节**：UDP首部有4个字段，每个字段占据2个字节，分别是源端口号、目的端口号、长度和检验和，而TCP分组首部开销需要20字节。
3. **不可靠的传输服务**：UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的链接状态表。

##### 优点：

1. 传输速率快：传输数据前，不需要像TCP一样建立连接；传输数据时，没有确认、窗口、重传、拥塞控制等机制。
2. 较安全，由于没有了TCP的一些机制，被攻击者利用的漏洞就少了。

##### 缺点：

1. 由于没有了TCP的机制，在数据传输时如果网络不好，很可能丢包。可以仿造TCP的做法，每发一个UDP包，都在里面加一个SEQ序号，接收方收到包后，将SEQ序号回复给发送方。如果发送方在指定时间以内没有收到回应，说明丢包了。

### 3.面向连接的运输：TCP

##### 特点：

1. TCP是面向连接的，因为在发送数据之前，它会进行“握手”操作，以建立确保数据传输的参数。
2. 提供全双工服务：数据可以从进程A流向进程B，也可以从进程B流行进程A。
3. 传递数据时，有确认、窗口、重传、拥塞控制。
4. 传递数据后，会断开连接节省系统资源。

##### 缺点：

1. 传递数据前，建立连接需要耗时。
2. 传递数据时，确认、重传、拥塞等会消耗大量时间以及CPU和内存等硬件资源。
3. 易被攻击：因为有确认机制，三次握手等机制，容易被人利用，实现DOS 、DDOS攻击。

##### TCP报文段结构

![](http://s1.sinaimg.cn/mw690/002knSYvgy6NiCTJiEM70&690)

1. **源端口和目的端口**：各占2个字节。
2. **序号和确认号**：各占4字节，被TCP发送方和接收方用来实现可靠数据传输。
3. **窗口**，占2个字节，用于流量控制。
4. **紧急URG**(URGent)：当URG=1时，表明紧急字段有效，告诉系统此报文中有紧急数据，应尽快传送。
5. **确认ACK**(ACKnowlegment)：用于指示确认字段中的值是有效的。
6. **推送PSH**(PuSH)：指接收方应立即将数据交给上层。
7. **复位RST、同步SYN、终止FIN**：用于连接的建立和拆除。
8. **选项**：长度可变，最长可达40字节，当没有选项时，TCP的首部长度是20字节。用于协商最大报文段长度MSS(每一个TCP报文段中的数据字段的最大长度)。

##### 流量控制

一条TCP连接每一侧的主机都为该连接设置了接收缓存，实际的收发操作也是通过套接字与缓存交互来完成的，就是套接字直接从套接字中读取和写入数据。当数据发送太快、太多时就会造成接收缓存溢出，因此需要特殊的流量控制来避免溢出。

TCP通过让发送方维护一个接收窗口进行浏览控制，即接收窗口用于给发送方一个提示——该接收方还有多少可用的缓存。

##### TCP连接管理

1.三次握手

![](http://dl2.iteye.com/upload/attachment/0108/8313/8352d9a8-8c91-32e5-adf8-2bdaf8d567d6.png)

1. 客户端通过TCP向服务器发送**SYN报文段**。它不包含应用层信息，其中的**SYN标志位为1**，然后选择一个**初始序号(client_isn)**，并将其放置在报文段的序号字段中。
2. 当SYN报文段到达服务器之后，服务器为该TCP连接分配TCP缓存和变量，并向该客户端发送**SYNACK报文段**。它不包含应用层信息，其中个的**SYN置为1**，**确认号字段**被置为client_isn+1，最后服务器选择自己的**初始序号(server_isn)**放在序号字段中。
3. 客户端收到SYNACK报文段之后，为连接分配缓存和变量，然后向服务器发送另一个报文段，其中将server_isn+1放在**确认字段**中，并将**SYN位置为0**.

2.四次挥手

![](http://dl2.iteye.com/upload/attachment/0108/8315/51a9937d-3155-3a95-b853-97e8e20e758b.png)

1. 客户端向服务器发送关闭连接报文段，其中FIN置为1。
2. 服务器接收到该报文段之后向发送方会送一个确认字段。
3. 服务器向客户端发送自己的终止报文段。
4. 客户端对服务器终止报文段进行确认。

3.TCP客户端和服务器的状态序列

![](http://uploadfiles.nowcoder.com/images/20160224/517164_1456313671265_072774B6B658B3603E1AA7198722775C)

重点是客户端和服务器分别在各个状态之间的转换。

### 4.常见面试题

##### 1.TCP协议和UDP协议的区别是什么

1. TCP协议是有连接的，有连接的意思是开始传输实际数据之前TCP的客户端和服务器端必须通过三次握手建立连接，会话结束之后也要结束连接。而UDP是无连接的。
2. TCP协议保证数据按序发送，按序到达，提供超时重传来保证可靠性，但是UDP不保证按序到达，甚至不保证到达，只是努力交付，即便是按序发送的序列，也不保证按序送到。
3. TCP协议所需资源多，TCP首部需20个字节（不算可选项），UDP首部字段只需8个字节。
4. TCP有流量控制和拥塞控制，UDP没有，网络拥堵不会影响发送端的发送速率。
5. TCP是一对一的连接，而UDP则可以支持一对一、多对多、一对多的通信。
6. TCP面向的是字节流的服务，UDP面向的是报文的服务。

##### 2.请详细介绍一下TCP协议建立连接和终止连接的过程？

三次握手和四次挥手的过程。

##### 3.三次握手建立连接时，发送方再次发送确认的必要性？

主要是为了防止已失效的连接请求报文段突然又传到了B,因而产生错误。假定出现一种异常情况，即A发出的第一个连接请求报文段并没有丢失，而是在某些网络结 点长时间滞留了，一直延迟到连接释放以后的某个时间才到达B，本来这是一个早已失效的报文段。但B收到此失效的连接请求报文段后，就误认为是A又发出一次 新的连接请求，于是就向A发出确认报文段，同意建立连接。假定不采用三次握手，那么只要B发出确认，新的连接就建立了，这样一直等待A发来数据，B的许多 资源就这样白白浪费了。

##### 4.四次挥手释放连接时，等待2MSL的意义？

1. 为了保证A发送的最有一个ACK报文段能够到达B。这个ACK报文段有可能丢失，因而使处在LAST-ACK状态的B收不到对已发送的FIN和ACK 报文段的确认。B会超时重传这个FIN和ACK报文段，而A就能在2MSL时间内收到这个重传的ACK+FIN报文段。接着A重传一次确认。
2. 防止上面提到的已失效的连接请求报文段出现在本连接中，A在发送完最有一个ACK报文段后，再经过2MSL，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。

##### 5.传播延迟的大小与下列哪些因素有关__________。

A.分组的位长L  B.链路传输率R位/秒  C.链路入口点与出口点的距离D米  D.路由器缓存大小M位

